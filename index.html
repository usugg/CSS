<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EdgeML Motion Collector</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background: #0b0f14; color: #e8eef5; }
    h1 { margin-top: 0; font-size: 1.4rem; }
    .card { max-width: 860px; margin: 0 auto; background: #121923; border: 1px solid #223043; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .row { display: grid; grid-template-columns: 160px 1fr; align-items: center; gap: 12px; margin-bottom: 14px; }
    input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3a53; background: #0f1622; color: #e8eef5; }
    .hint { color: #9fb3c8; font-size: 0.9rem; }
    .ok { color: #86efac; }
    .warn { color: #fcd34d; }
    .err { color: #fca5a5; }
    .btn { background: #2563eb; border: none; color: #fff; padding: 10px 14px; border-radius: 10px; cursor: pointer; }
    .btn[disabled] { opacity: 0.6; cursor: not-allowed; }
    .log { margin-top: 16px; border: 1px solid #223043; background: #0f1622; padding: 12px; border-radius: 12px; height: 180px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
    .tile { border: 1px solid #223043; border-radius: 12px; padding: 12px; background: #0f1622; text-align: center; }
    .value { display: block; font-size: 1.2rem; margin-top: 6px; }
    /* Toggle switch (from w3schools with tiny tweaks) */
    .switch { position: relative; display: inline-block; width: 52px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
              background-color: #334155; transition: .2s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px;
                     background-color: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background-color: #22c55e; }
    input:focus + .slider { box-shadow: 0 0 1px #22c55e; }
    input:checked + .slider:before { transform: translateX(24px); }
    footer { margin-top: 18px; font-size: 0.85rem; color: #91a4ba; }
    code { background: #0b1220; padding: 2px 6px; border-radius: 6px; border: 1px solid #223043; }
  </style>
  <!-- EdgeML JS via CDN (per https://github.com/edge-ml/javascript) -->
  <script src="https://unpkg.com/edge-ml/dist/bundle.js"></script>
</head>
<body>
  <div class="card">
    <h1>EdgeML Motion Collector</h1>
    <p class="hint">HTTPS required (Chrome, Safari). Use on a phone for real sensor data. In desktop Chrome you can emulate under <em>DevTools → More Tools → Sensors</em>.</p>

    <div class="row">
      <label for="context">Context</label>
      <input id="context" type="text" placeholder="e.g., walking, running, sitting" />
    </div>

    <div class="row">
      <label>Collect</label>
      <label class="switch">
        <input id="toggle" type="checkbox" />
        <span class="slider"></span>
      </label>
    </div>

    <div class="grid">
      <div class="tile">accX <span id="accx" class="value">–</span></div>
      <div class="tile">accY <span id="accy" class="value">–</span></div>
      <div class="tile">accZ <span id="accz" class="value">–</span></div>
    </div>

    <div style="margin-top:12px">
      <button id="finishBtn" class="btn" disabled>Finish & Upload Now</button>
    </div>

    <div id="status" class="hint" style="margin-top:10px"></div>
    <div id="log" class="log" aria-live="polite"></div>

    <footer>
      <div>Data sent to <code>beta.edgeml.org</code>. Keys visible in client code—treat as public. Rotate if exposed.</div>
    </footer>
  </div>

<script>
(() => {
  // ======= CONFIG: replace with your write key as needed =======
  const BACKEND_URL = "https://beta.edgeml.org";
  const DEVICE_API_KEY = "5fe6e50c3fb5001531bbd8e03a8c591f"; // provided by user
  const SERIES = ["accX","accY","accZ"]; // dataset time-series

  // ======= UI refs =======
  const contextEl = document.getElementById('context');
  const toggleEl  = document.getElementById('toggle');
  const finishBtn = document.getElementById('finishBtn');
  const statusEl  = document.getElementById('status');
  const logEl     = document.getElementById('log');
  const accxEl    = document.getElementById('accx');
  const accyEl    = document.getElementById('accy');
  const acczEl    = document.getElementById('accz');

  let collector = null;
  let running = false;
  let lastSent = 0;
  const MIN_INTERVAL_MS = 50; // ~20 Hz throttle

  function log(msg, cls="") {
    const el = document.createElement('div');
    if (cls) el.className = cls;
    const ts = new Date().toLocaleTimeString();
    el.textContent = `[${ts}] ${msg}`;
    logEl.appendChild(el);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function httpsGuard() {
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      statusEl.innerHTML = '⚠️ This page is not served over HTTPS. Motion sensors will be blocked.';
      statusEl.className = 'hint warn';
      toggleEl.disabled = true;
      return false;
    }
    statusEl.textContent = 'Ready.';
    statusEl.className = 'hint ok';
    return true;
  }

  async function requestMotionPermissionIfNeeded() {
    // iOS 13+ requires explicit permission request in user gesture
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
      try {
        const resp = await DeviceMotionEvent.requestPermission();
        if (resp !== 'granted') throw new Error('Permission not granted');
      } catch (e) {
        throw new Error('Motion permission denied on iOS: ' + e.message);
      }
    }
  }

  function onMotion(evt) {
    const now = Date.now();
    if (now - lastSent < MIN_INTERVAL_MS) return; // throttle
    lastSent = now;

    const acc = evt.accelerationIncludingGravity || evt.acceleration || {x:null,y:null,z:null};
    const x = (acc.x !== null) ? acc.x : 0;
    const y = (acc.y !== null) ? acc.y : 0;
    const z = (acc.z !== null) ? acc.z : 0;

    accxEl.textContent = x.toFixed(3);
    accyEl.textContent = y.toFixed(3);
    acczEl.textContent = z.toFixed(3);

    if (collector) {
      // When using device timestamps, send as (sensorName, value)
      try {
        collector.addDataPoint('accX', x);
        collector.addDataPoint('accY', y);
        collector.addDataPoint('accZ', z);
      } catch (e) {
        log('addDataPoint error: ' + e.message, 'err');
      }
    }
  }

  async function start() {
    const ctx = (contextEl.value || '').trim();
    if (!ctx) {
      alert('Please enter a Context, e.g., "walking" or "sitting".');
      toggleEl.checked = false;
      return;
    }
    try {
      await requestMotionPermissionIfNeeded();
      // Initialize EdgeML dataset collector (timestamps from device)
      collector = await edgeML.datasetCollector(
        BACKEND_URL,
        DEVICE_API_KEY,
        `Motion-${ctx}-${new Date().toISOString()}`,
        true,
        SERIES,
        { context: ctx, ua: navigator.userAgent },
        `context_${ctx}`
      );
      window.addEventListener('devicemotion', onMotion);
      running = true;
      finishBtn.disabled = false;
      statusEl.textContent = 'Collecting motion data…';
      statusEl.className = 'hint ok';
      log('Started collection for context="'+ctx+'"', 'ok');
    } catch (e) {
      toggleEl.checked = false;
      statusEl.textContent = 'Failed to start: ' + e.message;
      statusEl.className = 'hint err';
      log('Start error: ' + e.message, 'err');
    }
  }

  async function stop() {
    window.removeEventListener('devicemotion', onMotion);
    running = false;
    finishBtn.disabled = true;
    try {
      if (collector && collector.onComplete) {
        await collector.onComplete();
        log('Upload complete ✔', 'ok');
      }
    } catch (e) {
      log('onComplete error: ' + e.message, 'err');
    } finally {
      collector = null;
      statusEl.textContent = 'Stopped.';
      statusEl.className = 'hint';
    }
  }

  toggleEl.addEventListener('change', async () => {
    if (toggleEl.checked) start(); else stop();
  });

  finishBtn.addEventListener('click', async () => {
    if (running) {
      toggleEl.checked = false;
      await stop();
    }
  });

  // Desktop dev-tip: you can also experiment with DeviceOrientation
  // Uncomment below to quickly display orientation values in the log.
  /*
  window.addEventListener('deviceorientation', (e) => {
    log(`orientation α=${(e.alpha||0).toFixed(1)} β=${(e.beta||0).toFixed(1)} γ=${(e.gamma||0).toFixed(1)}`);
  });
  */

  httpsGuard();
})();  
</script>
</body>
</html>
